function htmldecode(a){return $("<div/>").html(a).text()}
var mobserv={inputfocus:null,globals:{client:{},user:{},services:{},talkies:{},translate:{license:"Servidor de Licen\u00e7as",service:"Servidor de Servi\u00e7os"}},debug:{active:!1,on:function(){$("#main").addClass("debug");mobserv.debug.active=!0;mobserv.notify.open({name:"Debug",message:"O modo debug est\u00e1 LIGADO."})},off:function(){$("#main").removeClass("debug");mobserv.debug.active=!1;mobserv.notify.open({name:"Debug",message:"O modo debug est\u00e1 DESLIGADO."})}},server:{timeout:12E4,pointer:0,
list:[{id:"srv0",type:"license",url:"http://ws.sourcelab.com.br/mobserv/rest/",online:!1,status:null,lastRequest:null},{id:"srv1",type:"license",url:"http://sourcelab.com.br/webservice/mobserv/rest/",online:!1,status:null,lastRequest:null},{id:"srv2",type:"license",url:"http://slab.ddns.net/metagen4/webservice/mobserv/rest/",online:!1,status:null,lastRequest:null}],queue:{},online:{license:!1,service:!1},data:function(a){$dom=$("#servers");$table=$dom.find("#"+a.id);$table.length||($table=$dom.find(".template").clone(),
$table.removeClass("template").attr("id",a.id).appendTo("#servers .section"));$table.find("#srvid").html(a.id);$table.find("#srvtype").html(a.type);$table.find("#srvurl").html(a.url);$table.find("#srvonline").css("color",a.online?"#09F":"#F00").html(a.online?"Sim":"N\u00e3o");$table.find("#srvstatus").html(a.status);$table.find("#srvlastrequest").html(a.lastRequest);$dom.find(".bigicon").css("color",a.online?"#09F":"#F00")},test:function(a){var b=mobserv.server.list[mobserv.server.pointer];if(b)if(mobserv.log({name:"server.test",
message:"init test on "+a+" server "+b.url}),a===b.type){b.status="Conectando";var c={xhrobj:null,aborttime:null,message:"Testando "+mobserv.globals.translate[a]+"...",cache:!1,type:"GET",url:b.url,dataType:"xml",success:function(c,d,e){""!==c&&1==$(c).find("mobserv").length?(b.online=!0,b.status="Conectado",mobserv.server.online[a]=b,mobserv.server.pointer=0,mobserv.log({type:"notice",name:"server.test",message:b.url+" is now the online "+a+" server"})):(b.online=!1,b.status="Erro de Parser",mobserv.log({type:"error",
name:"server.test",message:b.url+" response invalid xml"}),mobserv.server.pointer++,mobserv.server.test(a),$("#preload .loadinfo").text("Algo deu errado :("))},error:function(c,d,e){b.online=!1;b.status="Erro de Resposta";mobserv.log({type:"error",name:"server.test",message:b.url+" response error ("+(e?e:"unknown")+")"});$("#preload .loadinfo").text("Imposs\u00edvel conectar ao servidor :(");mobserv.server.pointer++;mobserv.server.test(a)},complete:function(){b.lastRequest=mobserv.now();mobserv.server.data(b);
mobserv.server.pointer==mobserv.server.list.length&&(mobserv.server.pointer=0);c.queued&&(delete mobserv.server.queue[c.id],$.each(mobserv.server.queue||[],function(a,b){mobserv.server.ajax(b);return!1}));clearTimeout(c.aborttime)},timeout:function(){c.aborttime=setTimeout(function(){c.xhrobj.abort();b.online=!1;b.status="Tempo de resposta esgotado";mobserv.log({type:"error",name:"server.test",message:b.url+" response timeout)"});$("#preload .loadinfo").text("O servidor n\u00e3o responde :(")},mobserv.server.timeout/
2)}};c.xhrobj=mobserv.server.ajax(c)}else mobserv.server.pointer++,mobserv.server.test(a)},loopcall:function(a,b,c,f){mobserv.server.test(a);var d,e=2*mobserv.server.timeout/1E3,g=setInterval(function(){if(d=mobserv.server.online[a])mobserv.server.call(a,b,c,f,!0),clearInterval(g);mobserv.connection.test()?0===e&&(mobserv.log({type:"error",name:"server.loopcall",message:"no "+a+" servers available"}),f&&f("Os servidores de "+("license"==d.type?"valida\u00e7\u00e3o de licen\u00e7a":"servi\u00e7o do cliente")+
" n\u00e3o responderam"),clearInterval(g)):clearInterval(g);e--},1E3)},call:function(a,b,c,f,d){var e=mobserv.server.online[a];if(!(e&&e.online||d))return mobserv.log({type:"alert",name:"server.call",message:e.url}),mobserv.server.loopcall(a,b,c,f),!1;mobserv.log({name:"server.call",message:"default "+a+" server request called",detail:"default "+a+" server request called"});e.status="Conectando";var g={xhrobj:null,aborttime:null,message:"Conectando ao "+mobserv.globals.translate[a]+"...",type:b.isPost?
"POST":"GET",url:e.url,dataType:"xml",data:b,xhr:function(){var a=new window.XMLHttpRequest,b=mobserv.now("timestamp"),c,e;a.addEventListener("progress",function(a){a.lengthComputable&&(c=mobserv.now("timestamp"),e=c-b,mobserv.connection.speed=(mobserv.connection.speed+a.loaded/e*1024)/2,mobserv.connection.traffic+=a.loaded/1204,mobserv.connection.parsedom())},!1);return a},success:function(d,g,l){""!==d&&1==$(d).find("mobserv").length?(e.online=!0,e.status="Conectado",e.lastRequest=mobserv.now(),
mobserv.server.online[a]=e,mobserv.log({type:"info",name:"server.call",message:"default "+a+" server request complete",detail:b?decodeURIComponent($.param(b)).replace(/\&/g,"<br>"):""}),c&&c(d,g,l)):(e.online=!1,e.status="Erro de Parser",e.lastRequest=mobserv.now(),mobserv.log({type:"error",name:"server.call",message:"default "+a+" server response invalid xml",detail:b?decodeURIComponent($.param(b)).replace(/\&/g,"<br>"):""}),$("#preload .loadinfo").text("Algo deu errado :("),mobserv.server.loopcall(a,
b,c,f))},error:function(d,g,l){e.online=!1;e.status="Erro de Conex\u00e3o";mobserv.log({type:"error",name:"server.call",message:"default "+a+" server response error ("+(l?l:"unknown")+")",detail:b?decodeURIComponent($.param(b)).replace(/\&/g,"<br>"):""});$("#preload .loadinfo").text("Imposs\u00edvel conectar ao servidor :(");mobserv.server.loopcall(a,b,c,f)},complete:function(){e.lastRequest=mobserv.now();mobserv.server.data(e);g.queued&&(delete mobserv.server.queue[g.id],$.each(mobserv.server.queue||
[],function(a,b){mobserv.server.ajax(b);return!1}));clearTimeout(g.aborttime)},timeout:function(){g.aborttime=setTimeout(function(){g.xhrobj.abort();e.online=!1;e.status="Tempo de resposta esgotado";mobserv.log({type:"error",name:"server.call",message:"default "+a+" server response timeout)",detail:b?decodeURIComponent($.param(b)).replace(/\&/g,"<br>"):""});$("#preload .loadinfo").text("O servidor n\u00e3o responde :(")},mobserv.server.timeout/2)}};g.xhrobj=mobserv.server.ajax(g)},ajax:function(a){a.id=
$.md5(a.url+(a.data?decodeURIComponent($.param(a.data)):""));if(a.data){a.data.device={model:mobserv.device.data.model,platform:mobserv.device.data.platform,version:mobserv.device.data.version};var b=mobserv.geolocation.position;a.data.gps={};a.data.gps.lat=b.latitude;a.data.gps.lon=b.longitude;a.data.gps.accuracy=b.accuracy;a.data.gps.altitude=b.altitudeAccuracy;a.data.gps.head=b.heading;a.data.gps.speed=b.speed;a.data.gps.timestamp=b.timestamp}else a.data={};mobserv.debug.active&&(a.data.debug=
"on");if(mobserv.connection.test())return $("#preload").addClass("courtain"),$("#preload .loadinfo").text(a.message?a.message:"Conectando..."),a.timeout&&a.timeout(),$.ajax(a);$("#preload .loadinfo").text("Sem internet :(");a.queued=!0;mobserv.server.queue[a.id]=a;mobserv.log({type:"alert",name:"server.ajax.queue",message:a.url+" request pushed to queue",detail:a.data?decodeURIComponent($.param(a.data)).replace(/\&/g,"<br>"):""});mobserv.notify.open({type:"alert",name:"Sem internet",message:"A transa\u00e7\u00e3o ser\u00e1 enviada quando a conex\u00e3o for reestabelicida"})}},
device:{ready:!1,data:{},init:function(){mobserv.globals.client={};mobserv.globals.user={};mobserv.device.ready=!0;if("undefined"!=typeof cordova.getAppVersion)cordova.getAppVersion().then(function(a){mobserv.device.data.appver=a?a:"0.0";$(".appver").html(mobserv.device.data.appver);$("#appver").html(mobserv.device.data.appver);mobserv.log({type:"notice",name:"device.appver",message:"device application native version: "+mobserv.device.data.appver})});else{var a="0.0";$.ajax({type:"GET",url:"config.xml",
dataType:"xml",success:function(c,f,d){a=$(c).find("widget").attr("version");mobserv.device.data.appver=a;$(".appver").html(mobserv.device.data.appver);b.find("#appver").html(mobserv.device.data.appver);mobserv.log({type:"notice",name:"device.appver",message:"device application local xml version: "+mobserv.device.data.appver})}})}"object"==typeof device?(mobserv.device.data=device,mobserv.log({type:"notice",name:"device.init",message:"device "+mobserv.device.data.platform+" is ready"})):(mobserv.device.data.cordova=
!1,mobserv.device.data.model=$.browser.mobile?"Mobile":"Desktop",mobserv.device.data.platform=$.browser.platform,mobserv.device.data.uuid=$.md5($.browser.name+$.browser.platform+$.browser.version+$.browser.versionNumber),mobserv.device.data.version=$.browser.version,mobserv.log({type:"alert",name:"device.onready",message:"native device properties not available"}));"iOS"==mobserv.device.data.platform&&$("#main").addClass("ios");var b=$("#about");b.length&&(b.find("#cordova").html(mobserv.device.data.cordova),
b.find("#model").html(mobserv.device.data.model),b.find("#platform").html(mobserv.device.data.platform),b.find("#uuid").html(mobserv.device.data.uuid),b.find("#version").html(mobserv.device.data.version))}},battery:{level:100,plugged:!0,idle:!0,parsedom:function(){var a=$("#battery");10>=mobserv.battery.level?(a.find(".bigicon").css("color","#F10"),a.find("#level").css("color","#F10")):20>=mobserv.battery.level?(a.find(".bigicon").css("color","#F70"),a.find("#level").css("color","#F70")):(a.find(".bigicon").css("color",
"#09F"),a.find("#level").css("color","#09F"));a.find("#level").html(mobserv.battery.level+"%");a.find("#plugged").html(mobserv.battery.plugged?"Conectado":"N\u00e3o Conectado");a.find("#idle").html(mobserv.battery.idle?"Normal":"Avan\u00e7ado")},init:function(){window.addEventListener("batterycritical",function(a){mobserv.battery.level=a.level;(mobserv.battery.plugged=a.isPlugged)?mobserv.battery.idle=!0:(mobserv.battery.idle=!1,mobserv.notify.open({type:"alert",name:"N\u00edvel cr\u00edtico de bateria",
message:"Recarregue seu dispositivo para continuar usando o mobserv"}),mobserv.notification.open({title:"N\u00edvel cr\u00edtico de bateria",text:"Recarregue seu dispositivo para continuar usando o mobserv",sound:"alert.mp3",icon:"ico-notification-error.png"}));mobserv.battery.parsedom()},!1);window.addEventListener("batterylow",function(a){mobserv.battery.level=a.level;(mobserv.battery.plugged=a.isPlugged)?mobserv.battery.idle=!0:(mobserv.battery.idle=!1,mobserv.notify.open({type:"alert",name:"Pouca bateria",
message:"Recarregue seu dispositivo para continuar usando o mobserv"}),mobserv.notification.open({title:"Pouca bateria",text:"Recarregue seu dispositivo para continuar usando o mobserv",sound:"alert.mp3",icon:"ico-notification-alert.png"}));mobserv.battery.parsedom()},!1);window.addEventListener("batterystatus",function(a){mobserv.battery.level=a.level;mobserv.battery.plugged=a.isPlugged;mobserv.battery.idle=!0;mobserv.battery.parsedom()},!1);mobserv.log({type:"notice",name:"battery.init",message:"battery api is loaded"});
mobserv.battery.parsedom()}},keyboard:{visible:!1,init:function(){window.addEventListener("native.keyboardshow",function(a){var b,c,f,d,e=$("#main");mobserv.inputfocus&&mobserv.inputfocus.data("disablescroll")?(cordova.plugins.Keyboard.disableScroll(!0),e.css({height:$(window).height()-a.keyboardHeight+"px",top:"auto",bottom:"0px"}),b=!0):(cordova.plugins.Keyboard.disableScroll(!1),e.css({height:"100%",top:"0px",bottom:"auto"}),b=!1);mobserv.inputfocus&&mobserv.inputfocus.data("documentscroll")&&
(c=mobserv.inputfocus.data("documentscroll"),$(window).scrollTop("true"==c?0:c),$(document).scrollTop(c));mobserv.inputfocus&&mobserv.inputfocus.data("sectionscroll")&&(d=e.find(".view.current:eq(0)"),f=mobserv.inputfocus.data("sectionscroll"),d.find(".section").scrollTop(f));mobserv.inputfocus&&mobserv.inputfocus.data("hideaccessory")?(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),d=!0):(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!1),d=!1);mobserv.log({name:"native.keyboardshow",message:"keyboard has shown",
detail:"documentScroll: "+c+", sectionScroll: "+f+", disableScroll: "+(b?"true":"false")+", hideKeyboardAccessoryBar: "+(d?"true":"false")+", keyboardHeight: "+a.keyboardHeight+", $main.height: "+e.height()});mobserv.keyboard.visible=!0});window.addEventListener("native.keyboardhide",function(a){a=$("#main");cordova.plugins.Keyboard.disableScroll(!1);a.css({height:"100%"});mobserv.log({name:"native.keyboardhide",message:"keyboard has hidden"});mobserv.keyboard.visible=!1});mobserv.log({type:"notice",
name:"keyboard.init",message:"keyboard api is loaded"})},close:function(){cordova&&cordova.plugins&&cordova.plugins.Keyboard&&cordova.plugins.Keyboard.isVisible&&cordova.plugins.Keyboard.close()}},menubutton:{init:function(){document.addEventListener("menubutton",function(a){a.preventDefault();$(".view.current:not(.disable) .menu").trigger("tap")},!1)}},backbutton:{init:function(){document.addEventListener("backbutton",function(a){a.preventDefault();0<mobserv.history.length?$(".view.current .back, .view.current .close").trigger("tap"):
mobserv.nav.foreground("confirmexit")},!1)}},insomnia:{init:function(){window.plugins.insomnia&&window.plugins.insomnia.keepAwake&&(window.plugins.insomnia.keepAwake(function(){mobserv.log({type:"notice",name:"insomnia.keepAwake",message:"the device will be awake for a life"})},function(){mobserv.log({type:"error",name:"insomnia.keepAwake",message:"the device will sleep anyway"})}),mobserv.log({type:"notice",name:"insomnia.init",message:"insomnia api is loaded"}))}},bgmode:{active:!1,init:function(){if(cordova&&
cordova.plugins&&cordova.plugins.backgroundMode){var a,b=0;cordova.plugins.backgroundMode.enable();cordova.plugins.backgroundMode.onactivate=function(){b=0;mobserv.bgmode.active=!0;mobserv.auth.loggedin()&&(mobserv.services.autogetspeed=2,mobserv.talkies.autogetspeed=2,mobserv.geolocation.autopostionspeed=2,mobserv.services.autoreset(),mobserv.talkies.autoreset(),mobserv.geolocation.autoPosition());mobserv.log({type:"info",name:"backgroundMode.onactivate",message:"the background mode is active"});
a=setInterval(function(){b++;mobserv.log({name:"backgroundMode.onactivate",message:"the background mode is rolling",detail:"hops: "+b+" minutes"})},6E4)};cordova.plugins.backgroundMode.ondeactivate=function(){mobserv.bgmode.active=!1;mobserv.auth.loggedin()&&(mobserv.services.autogetspeed=1,mobserv.talkies.autogetspeed=1,mobserv.geolocation.autopostionspeed=1,mobserv.services.autoreset(),mobserv.talkies.autoreset(),mobserv.geolocation.autoPosition());mobserv.log({type:"info",name:"backgroundMode.ondeactivate",
message:"the background mode is inactive"});clearInterval(a)};cordova.plugins.backgroundMode.onfailure=function(){mobserv.bgmode.active=!1;mobserv.log({type:"error",name:"backgroundMode.onfailure",message:"the background mode trigger error"});clearInterval(a)};mobserv.log({type:"notice",name:"bgmode.init",message:"bgmode api is loaded"})}}},connection:{online:!1,type:!1,speed:0,traffic:0,parsedom:function(){var a=$("#connectioninfo");navigator.connection?(a.find("#conntype").html(mobserv.connection.type),
navigator.connection.type==Connection.NONE?(a.find("#connstatus").html("Offline").css("color","#F60"),a.find(".bigicon").css("color","#F60")):(a.find("#connstatus").html("Online").css("color","#09F"),a.find(".bigicon").css("color","#09F"))):(a.find("#connstatus").html("Online (default)").css("color","#09F"),a.find("#conntype").html("Test impossible"),a.find(".bigicon").css("color","#09F"));a.find("#connspeed").html(mobserv.connection.speed.toFixed(2)+" kbps");a.find("#conntraffic").html(mobserv.connection.traffic.toFixed(2)+
" KB")},test:function(a){if(navigator.connection){a=navigator.connection.type;var b={};b[Connection.UNKNOWN]="Conex\u00e3o Desconhecida";b[Connection.ETHERNET]="Conex\u00e3o de Rede";b[Connection.WIFI]="Conex\u00e3o WiFi";b[Connection.CELL_2G]="Conex\u00e3o 2G";b[Connection.CELL_3G]="Conex\u00e3o 3G";b[Connection.CELL_4G]="Conex\u00e3o 4G";b[Connection.CELL]="Conex\u00e3o de Dados";b[Connection.NONE]="Sem Conex\u00e3o";mobserv.connection.type=b[a];if(navigator.connection.type==Connection.NONE)return mobserv.connection.online=
!1,mobserv.log({type:"alert",name:"connection.test",message:"no internet connection"}),mobserv.connection.parsedom(),!1;mobserv.connection.online=!0;mobserv.connection.parsedom();return!0}mobserv.connection.online=!0;mobserv.connection.parsedom();return!0}},geolocation:{position:{},interval:null,watchID:null,animID:null,autopostionspeed:1,animate:function(a,b,c,f){function d(){l+=g;p+=h;n+=k;var a=new google.maps.LatLng(l,p);b.setPosition(a);c.setCenter(a);c.setRadius(n);25!=e&&(e++,setTimeout(d,
10))}$(".view#map:visible .map");var e=0,g,h,k,l=b.getPosition().lat(),p=b.getPosition().lng(),n=c.getRadius(),e=0;g=(mobserv.geolocation.position.latitude-l)/25;h=(mobserv.geolocation.position.longitude-p)/25;k=(mobserv.geolocation.position.accuracy-n)/25;f&&a.panTo({lat:mobserv.geolocation.position.latitude,lng:mobserv.geolocation.position.longitude});d()},panMap:function(a){var b=$(".view#map:visible .map");if(b.length){var c=b.gmap3("get");b.length&&(a=$(".view#map:visible .item.location").hasClass("hilite")?
!0:a,b.gmap3({get:{name:"marker",tag:"mydevice",callback:function(f){f&&b.gmap3({get:{name:"circle",callback:function(b){b&&mobserv.geolocation.animate(c,f,b,a)}}})}}}))}},parsedom:function(a){var b;b=a.coords.heading;b=0<=b&&22.5>b?"N":67.5>b?"NE":112.5>b?"E":157.5>b?"SE":202.5>b?"S":247.5>b?"SW":292.5>b?"W":337.5>b?"NW":382.5>b?"N":"-";var c=a.coords.speed?parseInt(3.6*a.coords.speed):0;mobserv.geolocation.position.latitude=a.coords.latitude||0;mobserv.geolocation.position.longitude=a.coords.longitude||
0;mobserv.geolocation.position.accuracy=a.coords.accuracy||0;mobserv.geolocation.position.altitude=a.coords.altitude||0;mobserv.geolocation.position.altaccuracy=a.coords.altitudeAccuracy||0;mobserv.geolocation.position.heading=parseInt(a.coords.heading)||0;mobserv.geolocation.position.direction=b;mobserv.geolocation.position.speed=c;mobserv.geolocation.position.timestamp=a.timestamp||0;mobserv.geolocation.panMap();a=$("#map");a.find("#gpslat").html(mobserv.geolocation.position.latitude);a.find("#gpslng").html(mobserv.geolocation.position.longitude);
a.find("#gpsacr").html(mobserv.geolocation.position.accuracy);a.find("#gpsalt").html(mobserv.geolocation.position.altitude);a.find("#gpsact").html(mobserv.geolocation.position.altaccuracy);a.find("#gpsdir").html(mobserv.geolocation.position.heading+"&deg; "+mobserv.geolocation.position.direction);a.find("#gpsvel").html(mobserv.geolocation.position.speed+" km/h");a.find("#gpsstp").html(mobserv.geolocation.position.timestamp)},autoPosition:function(a){var b=mobserv.battery.idle?6E4*mobserv.geolocation.autopostionspeed:
6E5;a=a||{};mobserv.geolocation.getPosition(a);mobserv.geolocation.interval&&clearInterval(mobserv.geolocation.interval);mobserv.geolocation.interval=setInterval(function(){mobserv.geolocation.getPosition(a)},b);mobserv.log({name:"geolocation.autoPosition",message:"auto scheduled position started for every "+b/1E3+" seconds"})},getPosition:function(a){a=a||{};navigator.geolocation.getCurrentPosition(function(a){mobserv.geolocation.parsedom(a);mobserv.log({type:"notice",name:"geolocation.getPosition",
message:"position has gotten",detail:"lat: "+a.coords.latitude+", lng: "+a.coords.longitude})},function(a){mobserv.log({type:"alert",name:"geolocation.getPosition",code:a.code,message:a.message});a.PERMISSION_DENIED&&mobserv.notify.open({type:"alert",name:"Geoposi\u00e7\u00e3o desabilitada",message:"Habilite a permiss\u00e3o para acesso a geoposi\u00e7\u00f5es pelo Mobserv nas configura\u00e7\u00f5es do seu aparelho"})},a)},watchPosition:function(a){mobserv.log({type:"notice",name:"geolocation.watchPosition",
message:"watch position started"});mobserv.geolocation.watchID||(a=a||{},mobserv.geolocation.watchID=navigator.geolocation.watchPosition(function(a){clearInterval(mobserv.geolocation.interval);mobserv.geolocation.parsedom(a)},function(a){mobserv.log({type:"error",name:"geolocation.watchPosition",code:a.code,message:a.message});a.PERMISSION_DENIED&&mobserv.notify.open({type:"alert",name:"Geoposi\u00e7\u00e3o desabilitada",message:"Habilite a permiss\u00e3o para acesso a geoposi\u00e7\u00f5es pelo Mobserv nas configura\u00e7\u00f5es do seu aparelho"})},
a))},clearWatch:function(){mobserv.log({name:"geolocation.clearWatch",message:"watch position cleared"});mobserv.geolocation.watchID&&navigator.geolocation.clearWatch(mobserv.geolocation.watchID);mobserv.geolocation.autoPosition()}},sqlite:{db:null,plugin:{},init:function(){mobserv.log({name:"sqlite.init",message:"db mobserv.db initializing"});mobserv.sqlite.db=!window.sqlitePlugin&&window.openDatabase?window.openDatabase("mobserv.db","1.0","Mobserv Local Database",2E5):window.sqlitePlugin.openDatabase({name:"mobserv.db",
androidLockWorkaround:1,location:2});mobserv.sqlite.create()},create:function(){mobserv.sqlite.db.transaction(function(a){a.executeSql('CREATE TABLE IF NOT EXISTS sl_clients ("id" integer primary key, "name" text, "code" text, "password" text, "license" text, "install" text, "active" integer )');a.executeSql('CREATE TABLE IF NOT EXISTS sl_users ("id" integer primary key, "code" text, "login" text, "password" text, "session" text, "name" text, "active" integer )');a.executeSql('CREATE TABLE IF NOT EXISTS sl_services ("id" integer primary key, "code" text, "login" text, "xml" text )');
a.executeSql('CREATE TABLE IF NOT EXISTS sl_talkies ("id" integer primary key, "code" text, "login" text, "xml" text )');mobserv.log({type:"notice",name:"sqlite.create",message:"tables in mobserv.db are idle"})},function(a){mobserv.log({type:"error",name:"sqlite.create",message:"transaction error: "+a.message})})},clear:function(){mobserv.sqlite.db.transaction(function(a){a.executeSql("DROP TABLE IF EXISTS sl_clients");a.executeSql("DROP TABLE IF EXISTS sl_users");a.executeSql("DROP TABLE IF EXISTS sl_services");
a.executeSql("DROP TABLE IF EXISTS sl_talkies");mobserv.log({type:"notice",name:"sqlite.clear",message:"tables in mobserv.db was cleared"});mobserv.sqlite.create();mobserv.notify.open({name:"SQLite",message:"O SQLite foi restaurado"})},function(a){mobserv.log({type:"error",name:"sqlite.clear",message:"transaction error: "+a.message})})},drop:function(){window.sqlitePlugin.deleteDatabase({name:"mobserv.db",location:2},function(){mobserv.log({type:"notice",name:"sqlite.drop",message:"mobserv.db droped"})},
function(a){mobserv.log({type:"error",name:"sqlite.drop",message:"mobserv.db was not droped: "+a.message})})},loop:function(a,b,c){var f=mobserv.server.timeout/100,d=setInterval(function(){mobserv.sqlite.db&&(mobserv.sqlite.query(a,b,c,!0),clearInterval(d));0===f&&(mobserv.log({type:"error",name:"sqlite.loop",message:"no database available"}),c&&c("O banco de dados n\u00e3o est\u00e1 dispon\u00edvel"),clearInterval(d));f--},100)},query:function(a,b,c,f){var d=mobserv.sqlite.db,e="object"==typeof a?
a.statement:[];a="object"==typeof a?a.query:a;if(!d&&!f)return mobserv.log({type:"alert",name:"sqlite.query",message:"databse is stoped"}),mobserv.sqlite.loop(a,b,c),!1;d&&a&&d.transaction(function(c){c.executeSql(a,e,function(c,e){b&&b(e);mobserv.log({type:"info",name:"sqlite.query",message:"query executed: "+a,detail:"rows: "+e.rows.length+", rowsAffected: "+e.rowsAffected})})},function(b){c&&c(b.message);mobserv.log({type:"error",name:"sqlite.query",message:"query error: "+b.message,detail:a})})}},
auth:{loggedin:function(){return mobserv.globals.user.session&&mobserv.globals.client.license?!0:!1},clientdom:function(){var a=mobserv.globals.client;$("#formuser .client").text(a.name);$("#nav .client").text(a.name);var b=$("#user");b.find("#code").text(a.code);b.find("#cname").text(a.name);b.find("#install").text(a.install);b.find("#license").text(a.license)},userdom:function(){var a=mobserv.globals.user;$("#footer .user strong").text(a.login);$("#footer .user small").text(a.name);var b=$("#user");
b.find("#login").text(a.login);b.find("#uname").text(a.name);b.find("#session").text(a.session)},logout:function(a){var b=mobserv.globals.client,c=mobserv.globals.user;!c.login||"client"!=a&&"user"!=a&&a||($("#formuser"),mobserv.sqlite.query('update sl_users set active = 0, session = "" where login = "'+c.login+'"',function(a){mobserv.globals.user={};mobserv.log({type:"notice",name:"auth.logout.user",message:"user was loged out"});mobserv.services.autogettimeout&&clearTimeout(mobserv.services.autogettimeout);
mobserv.talkies.autogettimeout&&clearTimeout(mobserv.talkies.autogettimeout);mobserv.geolocation.interval&&clearInterval(mobserv.geolocation.interval);mobserv.geolocation.watchID&&navigator.geolocation.clearWatch(mobserv.geolocation.watchID)}));!b.code||"client"!=a&&a||($("#formclient"),mobserv.sqlite.query('update sl_clients set active = 0 where code = "'+b.code+'"',function(a){mobserv.globals.client={};mobserv.log({type:"info",name:"auth.logout.client",message:"client was loged out"})}),$.each(mobserv.server.list||
[],function(a,b){"service"==b.type&&delete b}))},client:function(a,b,c,f){var d=mobserv.globals.client;mobserv.server.call("license",b,function(b){d.response=b;var g=$(b),h=g.find("validation:eq(0)");if(h.length){var k=h.attr("status");mobserv.log({type:k,name:"auth.client",message:k+" validation: "+h.text()});"info"==k||"notice"==k?(b=g.find("license:eq(0)"),d.name=b.attr("client"),d.code=b.attr("cid"),d.license=b.attr("number"),d.install=b.attr("install"),d.active=1,0==a.rows.length?mobserv.sqlite.query('insert into sl_clients (name, code, password, license, install, active) values ("'+
d.name+'", "'+d.code+'", "'+d.password+'", "'+d.license+'", "'+d.install+'", '+d.active+")",function(a){d.id=a.insertId}):mobserv.sqlite.query('update sl_clients set name = "'+d.name+'", code = "'+d.code+'", password = "'+d.password+'", license = "'+d.license+'", install = "'+d.install+'", active = '+d.active+' where code = "'+d.code+'"'),g=g.find("server"),0<g.length?g.each(function(){var a=$(this),b=a.attr("name"),c=a.attr("icon"),e=a.attr("url"),a=a.attr("interval");e?(c&&$(".service-icon").switchClass("icon-package5",
c),b?(d.servertitle=b,$(".service-name").text(b)):d.servertitle="Servi\u00e7os",mobserv.server.list.push({id:"srv"+mobserv.server.list.length,type:"service",url:e,online:!1,status:null,lastRequest:null,interval:parseInt(a?a:300)}),mobserv.log({type:"notice",name:"auth.client.serviceserver",message:"added service server: "+e})):(mobserv.log({type:"error",name:"auth.client",message:"client do not have a service server url"}),mobserv.notify.open({type:"error",name:"Valida\u00e7\u00e3o do Cliente",message:"O cliente n\u00e3o possui um endere\u00e7o de servidor de servi\u00e7os"}))}):
(mobserv.log({type:"error",name:"auth.client",message:"client do not have a service server"}),mobserv.notify.open({type:"error",name:"Valida\u00e7\u00e3o do Cliente",message:"O cliente n\u00e3o possui um servidor de servi\u00e7os"})),mobserv.auth.clientdom(),c&&c(h.text())):(mobserv.notify.open({type:k,name:"Valida\u00e7\u00e3o de Cliente",message:h.text()}),f&&f(b))}},function(a){mobserv.notify.open({type:"error",name:"Erro do Servidor",message:a});f&&f(a)})},user:function(a,b,c,f){var d=mobserv.globals.client,
e=mobserv.globals.user;mobserv.server.call("service",b,function(b){e.response=b;var h=$(b),k=h.find("validation:eq(0)");if(k.length){var l=k.attr("status");mobserv.log({type:l,name:"auth.user",message:l+" validation: "+k.text()});"info"==l||"notice"==l?(b=h.find("session:eq(0)"),e.code=d.code,e.name=b.attr("name"),e.login=b.attr("login"),e.session=b.text(),e.active=1,0==a.rows.length?mobserv.sqlite.query('insert into sl_users (code, name, login, password, session, active) values ("'+d.code+'", "'+
e.name+'", "'+e.login+'", "'+e.password+'", "'+e.session+'", '+e.active+")",function(a){e.id=a.insertId}):mobserv.sqlite.query('update sl_users set code = "'+e.code+'", name = "'+e.name+'", password = "'+e.password+'", session = "'+e.session+'", active = '+e.active+' where login = "'+e.login+'"'),mobserv.auth.userdom(),c&&c(k.text())):(mobserv.notify.open({type:"error",name:"Autentica\u00e7\u00e3o de Usu\u00e1rio",message:k.text()}),f&&f(b))}},function(a){mobserv.notify.open({type:"error",name:"Erro do Servidor",
message:a});f&&f(a)})},init:function(){mobserv.log({name:"auth.init",message:"auth initialized"});mobserv.sqlite.query("select * from sl_clients where active = 1",function(a){if(0==a.rows.length)mobserv.nav.toView("formclient");else{var b=mobserv.globals.client=a.rows.item(0);mobserv.auth.client(a,{exec:"getLicense","in":b.install,cid:b.code,pw:b.password},function(a){mobserv.sqlite.query('select * from sl_users where code = "'+b.code+'" and active = 1',function(f){if(0==f.rows.length)mobserv.nav.toView("formuser"),
mobserv.notify.open({type:"info",name:"Valida\u00e7\u00e3o de Cliente",message:a});else{var d=mobserv.globals.user=f.rows.item(0);mobserv.auth.user(f,{exec:"authUser","in":b.install,cid:b.code,us:d.login,pw:d.password},function(){$(".footer").transition({y:0},300);mobserv.nav.toView("home");mobserv.services.init(function(){mobserv.services.get(function(){mobserv.talkies.init(function(){mobserv.talkies.get()})})})},function(){mobserv.nav.toView("formuser")})}},function(a){mobserv.nav.toView("formuser");
mobserv.notify.open({type:"error",name:"SQLite",message:a})})},function(){mobserv.nav.toView("formclient")})}},function(a){mobserv.nav.toView("formclient");mobserv.notify.open({type:"error",name:"SQLite",message:a})})}},services:{autogettimeout:null,autogetspeed:1,list:{},command:{viewBack:function(){mobserv.nav.back()},userLogout:function(){mobserv.nav.toView("formuser")},clientLogout:function(){mobserv.auth.logout("client");mobserv.nav.toView("formclient")},append:function(a,b,c){a.append(b)},prepend:function(a,
b,c){a.prepend(b)},after:function(a,b,c){a.find(c).length?a.find(c).after(b):a.append(b)},before:function(a,b,c){a.find(c).length?a.find(c).before(b):a.prepend(b)},removeNodes:function(a){var b=mobserv.globals.client,c=mobserv.globals.user,f=mobserv.globals.services,d="",e=0,g,h;a&&f.xml?(h=$(f.xml),g=h.find(a)):(h=$(f.xml),g=h.find("mobserv").children());e=g.length;0<e&&g.remove();f.xml=h.get(0);f.xml&&(d=(new XMLSerializer).serializeToString(f.xml));mobserv.sqlite.query({query:"update sl_services set xml = ? "+
(b.code&&c.login?'where code = "'+b.code+'" and login = "'+c.login+'"':""),statement:[d]},function(b){mobserv.services.parsedom();mobserv.log({type:"notice",name:"command.removeNodes",message:e+" nodes "+(a?' "'+a+'"':"")+" were removed"})})}},init:function(a){mobserv.log({name:"services.init",message:"services initialized"});var b=mobserv.globals.client,c=mobserv.globals.user,f=mobserv.globals.services;mobserv.sqlite.query('select xml from sl_services where code = "'+b.code+'" and login = "'+c.login+
'"',function(d){0<d.rows.length?(d.rows.item(0).xml?(f.cache=$.parseXML(d.rows.item(0).xml),f.xml=$.parseXML(d.rows.item(0).xml),d=$(f.xml),f.requestKey=d.find("mobserv").attr("resultKey"),mobserv.log({type:"notice",name:"services.init",message:d.length+" services dumped from local database"})):(f.xml="",f.requestKey=""),a&&a()):mobserv.sqlite.query('insert into sl_services (code, login, xml) values ("'+b.code+'", "'+c.login+'", "")',function(b){f.xml="";f.requestKey="";a&&a()})})},autoreset:function(){mobserv.services.autogettimeout&&
clearTimeout(mobserv.services.autogettimeout);mobserv.services.autoget()},autoget:function(){var a=mobserv.server.online.service,a=mobserv.battery.idle?1E3*a.interval*mobserv.services.autogetspeed:12E5;mobserv.log({name:"services.autoget",message:"service autoget scheduled in "+a/1E3+" seconds"});mobserv.services.autogettimeout=setTimeout(function(){mobserv.services.get()},a)},get:function(a){mobserv.log({name:"services.get",message:"services get start"});var b=mobserv.globals.client,c=mobserv.globals.user,
f=mobserv.globals.services,d={exec:"getServices",cid:b.code,sid:c.session,rk:f.requestKey};mobserv.services.autogettimeout&&clearTimeout(mobserv.services.autogettimeout);mobserv.server.call("service",d,function(e){f.response=e;mobserv.services.autoget();var d=$(e).find("mobserv");if(0==d.length)return mobserv.log({type:"error",name:"services.get",message:"mobserv node not found in service server response"}),!1;d.children("command").each(function(){var a=$(this);if(mobserv.services.command[a.attr("exec")])mobserv.services.command[a.attr("exec")](a.text(),
e);a.remove()});var h=d.find("validation"),k=d.children("service");d.children("mark");h.each(function(){var a=$(this),c=a.attr("status");mobserv.log({type:c,name:"services.get",message:c+" validation: "+a.text()});mobserv.notify.open({type:c,name:b.servertitle,message:a.text(),duration:5E3,tap:"info"==c||"notice"==c?function(){mobserv.nav.forward("services")}:null});mobserv.notification.open({title:b.servertitle,text:a.text(),sound:"beep2.mp3",icon:"ico-notification-info.png",bagde:mobserv.badge.get()},
function(){mobserv.nav.forward("servicelist")});a.remove()});f.requestKey=d.attr("resultKey");k.length?(f.xml=e,f.updated=!0,d=(new XMLSerializer).serializeToString(f.xml),mobserv.sqlite.query({query:'update sl_services set xml = ? where code = "'+b.code+'" and login = "'+c.login+'"',statement:[d]})):f.updated=!1;mobserv.services.parsedom();a&&a()},function(a){mobserv.services.autoget();mobserv.log({type:"error",name:"services.get",message:"get services error: "+a});mobserv.notify.open({type:"error",
name:"Erro ao sincronizar servi\u00e7os",message:a});mobserv.services.parsedom();onerror&&onerror(a)})},post:function(a,b){mobserv.log({name:"services.post",message:"services post start"});var c=mobserv.globals.client,f=mobserv.globals.user,d=mobserv.globals.services;"object"==typeof a&&(a.cid=c.code,a.sid=f.session,a.rk=d.requestKey,mobserv.server.call("service",a,function(a){d.response=a;var g=$(a).find("mobserv");if(0==g.length)return mobserv.log({type:"error",name:"services.post",message:"mobserv node not found in service server response"}),
!1;g.children("command").each(function(){var b=$(this);if(mobserv.services.command[b.attr("exec")])mobserv.services.command[b.attr("exec")](b.text(),a);b.remove()});var h=g.find("validation"),k=g.children("service");h.each(function(){var a=$(this),b=a.attr("status");mobserv.log({type:b,name:"services.post",message:b+" validation: "+a.text()});mobserv.notify.open({type:b,name:c.servertitle,message:a.text()});a.remove()});d.requestKey=g.attr("resultKey");k.length?(d.xml=a,d.updated=!0,g=(new XMLSerializer).serializeToString(d.xml),
mobserv.sqlite.query({query:'update sl_services set xml = ? where code = "'+c.code+'" and login = "'+f.login+'"',statement:[g]})):d.updated=!1;mobserv.services.parsedom();b&&b()},function(a){mobserv.log({type:"error",name:"services.post",message:"get services error: "+a});mobserv.notify.open({type:"error",name:"Erro ao postar servi\u00e7os",message:a});mobserv.services.parsedom();onerror&&onerror(a)}))},parsedom:function(a,b){if(!a){var c=$(".view.current:last");c.length?"servicelist"==c.attr("id")?
a="servicelist":"joblist"==c.attr("id")?(a="joblist",b=c.data("id")):"jobdetails"==c.attr("id")?(a="jobdetails",b=c.data("id")):a="servicelist":a="servicelist"}mobserv.log({name:"services.parsedom",message:"parsedom "+a+(b?" #"+b:"")+" started"});mobserv.services.cleardom(a);var f=mobserv.globals.services;if(!f.xml)return!1;var d,e,g,h,k,l,p,n,r,m="",c=$(f.xml).find("mobserv");if("servicelist"==a)d=$("#servicelist"),e=d.find(".list").html(""),d=c.find("service"),d.each(function(){var a=$(this),b=
{},c;a.children('layout:not([name="content"])').each(function(){var a=$(this);b[a.attr("name")]=htmldecode(a.text())});a.children("setting").each(function(){var a=$(this);a.attr("name");a.attr("value")});c=a.children("mark");m+='<li style="display:'+("true"==a.attr("visible")?"block":"none")+'" style="'+("true"==a.attr("disable")?".disable":"")+'"><div class="table link" data-view="joblist" data-direction="forward" data-id="'+a.attr("id")+'"><div><div class="identifier" style="background-color:'+
b.indentifierColor+'">'+b.indentifierLabel+"<strong>"+b.indentifierNumber+'</strong></div><mark class="'+c.attr("color")+'">'+c.text()+'</mark></div><div><h2 style="color:'+b.indentifierColor+'">'+b.title+"</h2>";a.children("layout").filter('[name="content"]').each(function(){m+="<p>"+htmldecode($(this).text())+"</p>"});m+="</div></div></li>"}),e.html(m);else if("joblist"==a&&b)$("#service"),g=$("#joblist"),e=g.find(".list").html(""),h=g.find(".gmap"),d=$(f.xml).find('service[id="'+b+'"]'),g.find("#screenname").text(d.attr("name")),
g=d.find("job"),g.each(function(){var a=$(this),b={};a.children("layout").each(function(){var a=$(this);b[a.attr("name")]=htmldecode(a.text())});a.children("setting").each(function(){var a=$(this);a.attr("name");a.attr("value")});m+='<li style="display:'+("true"==a.attr("visible")?"block":"none")+'" style="'+("true"==a.attr("disable")?".disable":"")+'"><div class="table link" data-view="jobdetails" data-direction="forward" data-id="'+a.attr("id")+'"><div><div class="identifier" style="background-color:'+
b.indentifierColor+'">'+b.indentifierLabel+"<strong>"+b.indentifierNumber+'</strong></div></div><div><h2 style="color:'+b.indentifierColor+'">'+b.title+"</h2>";a.children('layout[name="content"]').each(function(){m+="<p>"+htmldecode($(this).text())+"</p>"});m+="</div></div></li>"}),d.find("location").length?h.show().data("id",b):h.hide(),e.html(m);else if("jobdetails"==a&&b){var u={};g=$("#jobdetails");e=g.find(".list").html("");k=g.find(".dets").html("");l=g.find(".items").html("");p=g.find(".jobform .parsed").html("");
h=g.find(".gmap");$s=$(f.xml).find('job[id="'+b+'"]');d=$s.closest("service");$s.children("layout").each(function(){var a=$(this);u[a.attr("name")]=htmldecode(a.text())});$s.children("setting").each(function(){var a=$(this);a.attr("name");a.attr("value")});m+='<li style="display:'+("true"==$s.attr("visible")?"block":"none")+'" style="'+("true"==$s.attr("disable")?".disable":"")+'"><div class="table"><div><div class="identifier" style="background-color:'+u.indentifierColor+'">'+u.indentifierLabel+
"<strong>"+u.indentifierNumber+'</strong></div></div><div><h2 style="color:'+u.indentifierColor+'">'+u.title+"</h2>";$s.children('layout[name="content"]').each(function(){m+="<p>"+htmldecode($(this).text())+"</p>"});m+="</div></div></li>";e.html(m);m="";$s.children('layout[name="detail"]').each(function(){var a=$(this);m+='<tr><td style="width:1%;white-space:nowrap;">'+a.attr("label")+"</td><td><strong>"+htmldecode(a.text())+"</strong></td></tr>"});k.html(m);m="";e=$s.children("item");e.length&&(e.each(function(){var a=
$(this),b=a.attr("thumb")?'<div class="thumb" style="background-image:url('+a.attr("thumb")+');"></div>':a.attr("icon")?'<div class="icon icon-'+a.attr("icon")+'"></div>':'<div class="abbr">'+(a.attr("abbr")?a.attr("abbr"):"ITEM")+"</div>";m=$('<div class="item"><div class="check"></div><div class="image">'+b+'</div><div class="data"><h2 style="color:'+a.attr("color")+'">'+a.attr("name")+"</h2><p><b>"+a.attr("type")+"</b></p>"+(a.attr("barcode")?'<p class="icon-barcode">'+a.attr("barcode")+"</p>":
"")+'<input type="hidden" class="input hidden" name="'+(a.attr("field")?a.attr("field"):"Job_Item")+"["+a.attr("id")+']" /></div></div>');if(a.attr("barcode")&&"undefined"!=typeof cordova&&"undefined"!=typeof cordova.plugins&&"undefined"!=typeof cordova.plugins.barcodeScanner)m.on("tap",function(){var a=$(this);a.addClass("courtain");cordova.plugins.barcodeScanner.scan(function(b){!b.cancelled&&b.text&&(a.attr("barcode")==b.text?(a.removeClass("unmatch").addClass("match"),a.find(".input").val(b.text),
mobserv.log({type:"info",name:"item.barcode",message:"item "+b.text+" ("+b.format+","+b.cancelled+") match"}),mobserv.notify.open({type:"info",name:"Scanner",message:"Item "+b.text+" selecionado"})):(a.addClass("unmatch").removeClass("match"),a.find(".field").val(""),mobserv.log({type:"alert",name:"item.barcode",message:"item "+b.text+" ("+b.format+","+b.cancelled+") unmatch"}),mobserv.notify.open({type:"alert",name:"Scanner",message:"Item "+b.text+" n\u00e3o confere"})));a.removeClass("courtain")},
function(b){mobserv.log({type:"error",name:"item.barcode",message:"item "+result.text+" ("+result.type+","+result.cancelled+") has not match"});mobserv.notify.open({type:"error",name:"Scanner",message:"Item "+result.text+" n\u00e3o confere"});a.removeClass("courtain")})});else m.on("tap",function(){var a=$(this);a.hasClass("match")?(a.removeClass("match"),a.find(".input").val("")):(a.addClass("match"),a.find(".input").val(a.attr("id")))});l.append(m);m=""}),l.closest(".block").show());e=$s.find("form");
e=e.length?e:$s.closest("service").children('form[type="'+$s.attr("type")+'"]');e=e.length?e:$s.closest("mobserv").children('form[type="'+$s.attr("type")+'"]');e.length&&(k=e.children("description:eq(0)"),p.siblings(".formdesc").html(k.length?'<p class="description">'+k.text()+"</p>":'<p class="description">Formul\u00e1rio de intera\u00e7\u00e3o de '+$s.attr("type")+"</p>"),k=e.children("submit:eq(0)"),p.closest(".jobform").find(".submit").val(k.length?k.text():"Enviar Dados"),e.attr("action")&&p.siblings('.input[name="action"]').val(e.attr("action")),
e.attr("exec")&&p.siblings('.input[name="exec"]').val(e.attr("exec")),p.siblings('.input[name="service"]').val($s.closest("service").attr("id")),p.siblings('.input[name="job"]').val($s.attr("id")),e.find("formset").each(function(){var a=$(this);n=$('<div class="formset"></div>');var b=a.children("description:eq(0)");n.append(b.length?"<p>"+b.text()+"</p>":"");"false"==a.attr("visible")&&n.hide();a.attr("chain-field")&&n.attr("chain-field",a.attr("chain-field"));a.attr("chain-value")&&n.attr("chain-value",
a.attr("chain-value"));p.append(n);a.find("field").each(function(){var b=$(this);if("select"==b.attr("type"))r=$('<select name="'+b.attr("name")+'" class="input select" '+("true"==b.attr("required")?" required":"")+">"),r.append('<option value="" disabled selected>'+b.attr("label")+"</option>"),b.find("option").each(function(){var a=$(this);r.append('<option value="'+a.attr("value")+'">'+a.text()+"</option>")});else if("text"==b.attr("type")||"number"==b.attr("type")||"email"==b.attr("type"))r=$('<input type="'+
b.attr("type")+'" class="input '+b.attr("type")+'" placeholder="'+b.attr("label")+'"  '+("true"==b.attr("required")?" required":"")+" />");"true"==a.attr("disable")&&r.prop("disabled",!0);r.on("change",function(){var a=$(this),b=a.parent(),c=a.val(),a=a.attr("name");b.nextAll(".formset").hide().find(".input").val("");b.nextAll('.formset[chain-field="'+a+'"][chain-value="'+c+'"]').fadeIn()});n.append(r)});p.append(n)}));g.find("#interact").data("id",b);$s.find("location").length?h.show().data("id",
b):h.hide()}var t=$('#home [data-view="servicelist"] mark'),q=$('#footer [data-view="servicelist"] mark'),c=c.children("mark");d=d.length?d.children("mark"):null;c&&c.length?c.each(function(){var a=$(this);a.text()?f.updated||!q.is(":visible")?(t.text(a.text()).addClass(a.attr("color")).transition({opacity:1,scale:1.5},400,function(){t.transition({scale:1},200)}).closest("a").removeClass("unmarked"),q.text(a.text()).addClass(a.attr("color")).transition({opacity:1,scale:1.5},400,function(){q.transition({scale:1},
200)}).parent().addClass("marked")):(t.transition({opacity:1,scale:1.5},200,function(){t.text(a.text()).addClass(a.attr("color")).transition({scale:1},200).closest("a").removeClass("unmarked")}),q.transition({opacity:1,scale:1.5},200,function(){q.text(a.text()).addClass(a.attr("color")).transition({scale:1},200).parent().addClass("marked")})):(t.transition({opacity:0,scale:.01},300,function(){t.parent().closest("a").removeClass("unmarked")}),q.transition({opacity:0,scale:.01},300,function(){q.parent().parent().removeClass("marked")}))}):
(t.transition({opacity:0,scale:.01},100),q.transition({opacity:0,scale:.01},100));d&&d.length?d.each(function(){var a=$(this),b=a.parent(),c=$('#servicelist .link[data-id="'+b.attr("id")+'"] mark');a.text()?f.updated||!c.is(":visible")?c.transition({opacity:0,scale:.01},100,function(){c.text(a.text()).addClass(a.attr("color")).transition({opacity:1,scale:1.5},500,function(){c.transition({scale:1},200)})}):c.transition({opacity:1,scale:1.5},200,function(){c.text(a.text()).addClass(a.attr("color")).transition({scale:1},
200)}):c.transition({scale:1.5},200,function(){c.transition({opacity:0,scale:.01},300)})}):$("#servicelist .link mark").transition({opacity:0,scale:.01},100)},cleardom:function(a){a&&"serviceslist"!=a?"joblist"==a?$("#joblist .list").html(""):"jobdetails"==a&&($("#jobdetails .list").html(""),$("#jobdetails .dets").html(""),$("#jobdetails .items").html(""),$("#jobdetails .parsed").html("")):$("#servicelist .list").html("")}},talkies:{autogettimeout:null,autogetspeed:1,init:function(a){mobserv.log({name:"talkies.init",
message:"talkies initialized"});var b=mobserv.globals.client,c=mobserv.globals.user,f=mobserv.globals.talkies;mobserv.sqlite.query('select xml from sl_talkies where code = "'+b.code+'" and login = "'+c.login+'"',function(d){0<d.rows.length?(d.rows.item(0).xml?(f.cache=$.parseXML(d.rows.item(0).xml),f.xml=$.parseXML(d.rows.item(0).xml),d=$(f.xml),f.requestKey=d.find("mobserv").attr("resultKey"),mobserv.log({type:"notice",name:"talkies.init",message:d.find("talk").length+" talkies dumped from local database"})):
(f.xml="",f.requestKey=""),a&&a()):mobserv.sqlite.query('insert into sl_talkies (code, login, xml) values ("'+b.code+'", "'+c.login+'", "")',function(b){f.xml="";f.requestKey="";a&&a()})})},autoreset:function(){mobserv.talkies.autogettimeout&&clearTimeout(mobserv.talkies.autogettimeout);mobserv.talkies.autoget()},autoget:function(){var a=mobserv.server.online.service,a=mobserv.battery.idle?1E3*a.interval*mobserv.talkies.autogetspeed:12E5;mobserv.log({name:"talkies.autoget",message:"talkies autoget scheduled in "+
a/1E3+" seconds"});mobserv.talkies.autogettimeout=setTimeout(function(){mobserv.talkies.get()},a)},get:function(a){mobserv.log({name:"talkies.get",message:"talkies get start"});var b=mobserv.globals.client,c=mobserv.globals.user,f=mobserv.globals.talkies,d={exec:"getTalkies",cid:b.code,sid:c.session};mobserv.talkies.autogettimeout&&clearTimeout(mobserv.talkies.autogettimeout);mobserv.server.call("service",d,function(d){f.response=d;mobserv.talkies.autoget();var g=$(d).find("mobserv");if(0==g.length)return mobserv.log({type:"error",
name:"talk.get",message:"mobserv node not found in service server response to talkies"}),!1;g.children("command").each(function(){var a=$(this);if(mobserv.talkies.command[a.attr("exec")])mobserv.talkies.command[a.attr("exec")](a.text(),d);a.remove()});var g=g.children("talk"),h=mobserv.nav.getCurrentView("messages"),k=h.length?h.find(".section"):null;if(g.length){var l=0;if(f.xml){var p=$(f.xml),n=p.find("mobserv");g.each(function(){var a=$(this),b=a.attr("id"),c=n.find('talk[id="'+b+'"]'),d=a.find("message").attr("new",
"new");if(c.length){var e=c.find("message");50<e.length&&e.filter(":lt("+(e.length-50)+")").remove();d.length&&c.append(d);c.attr("name",a.attr("name"));c.attr("subject",a.attr("subject"));c.attr("lastdate",a.attr("lastdate"));c.attr("readed",a.attr("readed"));c.attr("color",a.attr("color"))}else n.append(a),c=n.find('talk[id="'+b+'"]');e=h.length&&h.data("id")==b?0:d.length+(c.attr("mark")?parseInt(c.attr("mark")):0);c.attr("mark",e+"");l+=e;mobserv.talkies.parsedom("talkies",b);h.length&&h.data("id")==
b&&(navigator.vibrate&&d.length&&navigator.vibrate(100),mobserv.talkies.parsedom("messages",b),(mobserv.inputfocus||k.hasClass("scrollend"))&&k.scrollTop(999999999));mobserv.bgmode.active&&d.length&&d.each(function(){$this=$(this);mobserv.notification.open({title:a.attr("name"),text:$this.attr("sender")+": "+$this.text(),sound:"beep.mp3",icon:"ico-notification-chat.png",bagde:mobserv.badge.get()},function(){$("#talkies").find('.list .link[data-id="'+b+'"]').trigger("tap")})})})}else f.xml=d,p=$(f.xml),
n=p.find("mobserv"),g.each(function(){var a=$(this),b=a.attr("id"),c=n.find('talk[id="'+b+'"]'),d=c.find("message").attr("new","new"),e=h.length&&h.data("id")==b?0:d.length;c.attr("mark",e+"");l+=e;mobserv.talkies.parsedom("talkies",b);h.length&&h.data("id")==b&&(navigator.vibrate&&d.length&&navigator.vibrate(100),mobserv.talkies.parsedom("messages",b),(mobserv.inputfocus||k.hasClass("scrollend"))&&k.scrollTop(999999999));mobserv.bgmode.active&&d.length&&d.each(function(){$this=$(this);mobserv.notification.open({title:a.attr("name"),
text:$this.attr("sender")+": "+$this.text(),sound:"beep.mp3",icon:"ico-notification-chat.png",bagde:mobserv.badge.get()},function(){mobserv.nav.forward("messages");mobserv.talkies.parsedom("messages",b)})})});!h.length&&l&&mobserv.notify.open({type:"info",name:"Mensagens",message:"Voc\u00ea possui <b>"+l+"</b> novas mensagens",duration:5E3,tap:function(){mobserv.nav.forward("talkies")}});n.attr("mark",l);g=(new XMLSerializer).serializeToString(f.xml);mobserv.sqlite.query({query:'update sl_talkies set xml = ? where code = "'+
b.code+'" and login = "'+c.login+'"',statement:[g]});mobserv.talkies.mark()}a&&a()},function(a){mobserv.talkies.autoget();mobserv.log({type:"error",name:"talkies.get",message:"get talkies error: "+a});mobserv.notify.open({type:"error",name:"Erro ao verificar novas mensagens",message:a});onerror&&onerror(a)})},post:function(a,b,c){mobserv.log({name:"talkies.post",message:"talkie message post start"});var f=mobserv.globals.client,d=mobserv.globals.user,e=mobserv.globals.talkies;"object"==typeof a&&
(a.cid=f.code,a.sid=d.session,mobserv.server.call("service",a,function(a){e.response=a;var h=$(a).find("mobserv");if(0==h.length)return c&&c("mobserv node not found in service server response to talkies"),!1;h.children("command").each(function(){var b=$(this);if(mobserv.talkies.command[b.attr("exec")])mobserv.talkies.command[b.attr("exec")](b.text(),a);b.remove()});h.find("validation").each(function(){var a=$(this),b=a.attr("status");if("info"!=b||"notice"!=b)return c&&c(htmldecode(a.text())),!1;
a.remove()});var k=h.children("talk");if(k.length)if(h=k.children("message"),k=$(e.xml).find('talk[id="'+k.attr("id")+'"]'),k.length)k.append(h),h=(new XMLSerializer).serializeToString(e.xml),mobserv.sqlite.query({query:'update sl_services set xml = ? where code = "'+f.code+'" and login = "'+d.login+'"',statement:[h]}),b&&b();else return c&&c("local talk node not found"),!1;else return c&&c("remote talk node not found"),!1},function(a){c&&c(a)}))},read:function(a){var b=mobserv.globals.client,c=mobserv.globals.user,
f=mobserv.globals.talkies;if(!f.xml)return!1;var d,e;d=$(f.xml).find("mobserv");var g=parseInt(d.attr("mark"));e=d.find('talk[id="'+a+'"]');var h=parseInt(e.attr("mark"));d.attr("mark",g-h);e.attr("readed","true");e.attr("mark","0");d=$("#messages");a=$("#talkies").find('.link[data-id="'+a+'"]');a.addClass("readed");d.find("#header h1").text(e.attr("name"));d.find("#header h2").text(e.attr("subject"));var k=a.find("mark");k.transition({opacity:0,scale:.01},300,function(){k.text("0")});f=(new XMLSerializer).serializeToString(f.xml);
mobserv.sqlite.query({query:'update sl_talkies set xml = ? where code = "'+b.code+'" and login = "'+c.login+'"',statement:[f]});mobserv.talkies.mark()},remove:function(a){var b=mobserv.globals.client,c=mobserv.globals.user,f=mobserv.globals.talkies;if(!f.xml)return!1;$(f.xml).find("mobserv").find('talk[id="'+a+'"]').find("message").remove();mobserv.talkies.cleardom();a=(new XMLSerializer).serializeToString(f.xml);mobserv.sqlite.query({query:'update sl_talkies set xml = ? where code = "'+b.code+'" and login = "'+
c.login+'"',statement:[a]});navigator.vibrate&&navigator.vibrate(100)},parsedom:function(a,b){if(!a){var c=mobserv.nav.getCurrentId();"talkies"==c?a="talkies":"messages"==c&&(a="messages")}mobserv.log({name:"talkies.parsedom",message:"parsedom "+a+(b?" #"+b:"")+" started"});c=mobserv.globals.talkies;if(!c.xml)return!1;var f="",d,e,g,h;h=$(c.xml).find("mobserv");c=h.children('talk[id="'+b+'"]');if("talkies"==a){if(d=$("#talkies"),d=d.find(".list"),c.length){var k=parseInt(c.attr("mark")||"0"),f=f+
('<li><div class="table link'+(k?"":" readed")+'" data-view="messages" data-direction="forward" data-id="'+c.attr("id")+'"><div><div class="icon icon-paperplane" style="color:'+c.attr("color")+'"></div><mark class="blue">'+k+'</mark></div><div><h2 style="color:'+c.attr("color")+'">'+c.attr("name")+'</h2><p><b style="color:'+c.attr("color")+'">'+c.attr("subject")+"</b></p><p><small>Ultima intera\u00e7\u00e3o: "+c.attr("lastdate")+"</small></p></div></div></li>");d.find('.link[data-id="'+c.attr("id")+
'"]').parent().remove();k?d.prepend(f):d.append(f);var l=d.find('.link[data-id="'+c.attr("id")+'"] mark');0<k?l.show().transition({opacity:1,scale:1.5},300,function(){l.text(k).transition({scale:1},200)}):"0"!=l.text()&&l.transition({opacity:0,scale:.01},300,function(){l.text("0").hide()})}}else"messages"==a&&(d=$("#messages"),e=d.find(".chat").html(""),c=h.children('talk[id="'+b+'"]'),c=c.find("message"),d.find("#header .remove").data("id",b),c.each(function(){var a=$(this);f=a.attr("me")?f+('<div class="talk me" id="'+
a.attr("id")+'"><div class="text">'+a.text()+'</div><div class="info"><span class="icon-clock">'+a.attr("time")+'</span></div></div><div class="clear"></div>'):f+('<div class="talk" id="'+a.attr("id")+'"><div class="text">'+a.text()+'</div><div class="info"><strong class="icon-user2">'+a.attr("sender")+'</strong><span class="icon-clock">'+a.attr("time")+'</span></div></div><div class="clear"></div>');e.html(f);"new"==a.attr("new")&&(g=e.find(".talk#"+a.attr("id")),g.transition({scale:1.1},200,function(){g.transition({scale:1},
150)}),a.removeAttr("new"))}))},cleardom:function(a){a&&"messages"!=a||$("#messages .chat").html("")},mark:function(){var a=mobserv.globals.talkies;if(!a.xml)return!1;var a=$(a.xml).find("mobserv"),a=parseInt(a.attr("mark")),b=$('#home [data-view="talkies"] mark'),c=$('#footer [data-view="talkies"] mark');a?(b.text(a).transition({opacity:1,scale:1.5},300,function(){b.transition({scale:1},200)}).closest("a").removeClass("unmarked"),c.text(a).transition({opacity:1,scale:1.5},300,function(){c.transition({scale:1},
200)}).parent().addClass("marked")):(b.transition({opacity:0,scale:.01},300,function(){b.text("0")}),c.transition({opacity:0,scale:.01},300,function(){c.text("0")}).parent().removeClass("marked"))}},zindex:3,preventTap:!1,timeoutTap:null,history:[],nav:{getCurrentId:function(){return $(".view.current:last").attr("id")},getCurrentView:function(a){return $((a?"#"+a:".view")+".current:last")},toView:function(a){var b=$(".view.current:last");a="string"==typeof a?$("#"+a):a;1==b.length&&1==a.length&&b.attr("id")!=
a.attr("id")?(b.transition({opacity:0},300,function(){b.hide().removeClass("current")}),a.css({x:0,opacity:0,"z-index":mobserv.zindex}).show().transition({opacity:1},300,function(){a.addClass("current")}),a.trigger("show"),b.trigger("hide")):1==a.length&&a.css({x:0,opacity:0,"z-index":mobserv.zindex}).show().transition({opacity:1},300,function(){a.addClass("current");a.trigger("current")});a.trigger("show");mobserv.zindex++},foreground:function(a){mobserv.zindex+=3;a="string"==typeof a?$("#"+a):a;
1==a.length&&a.css({x:0,opacity:0,"z-index":mobserv.zindex}).show().transition({opacity:1},300);a.trigger("show");mobserv.zindex++},close:function(a){a="string"==typeof a?$("#"+a):a;1==a.length&&a.transition({opacity:0},300,function(){a.hide();a.trigger("hide")})},forward:function(a){var b=$(".view.current:last");a="string"==typeof a?$("#"+a):a;1==b.length&&1==a.length&&b.attr("id")!=a.attr("id")&&(mobserv.history.push(b),b.transition({x:0,opacity:1},300,function(){b.hide().removeClass("current")}),
a.css({x:$("#nav").hasClass("active")?"-80%":"30%",opacity:0,"z-index":mobserv.zindex}).show().transition({x:0,opacity:1},300,function(){a.addClass("current");a.trigger("current")}),a.trigger("show"),b.trigger("hide"));mobserv.zindex++},back:function(){if(0<mobserv.history.length){var a=$(".view.current:last");$view=mobserv.history.pop();1==a.length&&1==$view.length&&a.attr("id")!=$view.attr("id")&&(a.transition({x:"30%",opacity:0},300,function(){a.hide().removeClass("current")}),$view.css({x:0,opacity:1}).show().transition({opacity:1},
300,function(){$view.addClass("current");$view.trigger("current")}),$view.trigger("show"),a.trigger("hide"));mobserv.zindex++}},link:function(a){if(!mobserv.preventTap){clearTimeout(mobserv.timeoutTap);mobserv.preventTap=!0;mobserv.timeoutTap=setTimeout(function(){mobserv.preventTap=!1},600);var b=a.data("view"),c;if(b){c=$("#"+b);var b=a.data("id"),f=a.data("source");b&&c.data("id",b);f&&c.data("source",f)}a=a.data("direction");c?"forward"==a?mobserv.nav.forward(c):"foreground"==a?mobserv.nav.foreground(c):
"close"==a?mobserv.nav.close(c):mobserv.nav.toView(c):"back"==a&&mobserv.nav.back()}}},mark:{},badge:{set:function(){},get:function(){var a=$('#home [data-view="servicelist"] mark'),b=$('#home [data-view="talkies"] mark'),a=(a.length?parseInt(a.text()):0)||0,b=(b.length?parseInt(b.text()):0)||0;return a+b}},notification:{id:1,events:[],inited:!1,init:function(){cordova.plugins.notification.local.registerPermission(function(a){mobserv.log({type:"notice",name:"notification.init",message:"notification permission: "+
a})});cordova.plugins.notification.local.on("trigger",function(a){var b=mobserv.notification.events[a.id];b&&b.trigger&&b.trigger(a)});cordova.plugins.notification.local.on("click",function(a){var b=mobserv.notification.events[a.id];b&&b.click&&b.click(a)});mobserv.notification.inited=!0},open:function(a,b,c){if(mobserv.notification.inited&&mobserv.bgmode.active){navigator.vibrate&&navigator.vibrate(300);var f=a.id?a.id:mobserv.notification.id;mobserv.notification.id++;cordova.plugins.notification.local.schedule({id:f,
title:$("<span>"+htmldecode(a.title)+"</span>").text(),text:$("<span>"+htmldecode(a.text)+"</span>").text(),badge:a.badge?a.badge:0,sound:a.sound?"file://sounds/"+a.sound:null,icon:a.icon?"file://pic/"+a.icon:null,data:a.data});c&&(mobserv.notification.events[f]={trigger:c});b&&(mobserv.notification.events[f]={click:b})}}},notify:{list:[],exec:function(){if(mobserv.notify.list.length){navigator.vibrate&&navigator.vibrate(300);var a=mobserv.notify.list[0],b=$("#notify");b.find("strong").html(a.name?
htmldecode(a.name):"");b.find("span").html(a.message?htmldecode(a.message):"");b.find("small").html(a.detail?htmldecode(a.detail):"");b.removeClass("error alert info notice").addClass(a.type?a.type:"").show().css({transform:"translate(0px, 40px);",opacity:0}).transition({y:0,opacity:1},300,function(){a.timeout=setTimeout(function(){mobserv.notify.close()},a.duration)});b.off("tap");b.one("tap",function(){mobserv.notify.close();a.tap&&a.tap()})}},close:function(){var a=mobserv.notify.list[0],b=$("#notify");
a.timeout&&clearTimeout(a.timeout);b.transition({y:"40px",opacity:0},300,function(){b.hide();mobserv.notify.list.shift();mobserv.notify.exec()})},open:function(a){if(mobserv.bgmode.active)return!1;a.id=$.md5(a.type+a.name+a.message);a.duration=a.duration||3E3;a.timeout=null;$.each(mobserv.notify.list||[],function(b,c){c.id==a.id&&(a.ignore=!0)});a.ignore||(0==mobserv.notify.list.length?(mobserv.notify.list.push(a),mobserv.notify.exec()):mobserv.notify.list.push(a))}},log:function(a){"error"==a.type&&
navigator.vibrate&&!mobserv.bgmode.active&&navigator.vibrate(500);if(mobserv.debug.active||!mobserv.debug.active&&"error"==a.type){var b='<div class="logline '+(a.type?a.type:"")+'"><b class="date">['+mobserv.now()+" "+Date.now()+"]</b> "+(a.name?'<b class="name">'+htmldecode(a.name)+"</b> ":"")+(a.title?'<b class="title">'+htmldecode(a.title)+"</b> ":"")+(a.message?'<br><span class="message">'+htmldecode(a.message)+"</span> ":"")+(a.detail?'<br><span class="detail">'+htmldecode(a.detail)+"</span> ":
"")+"</div>";$("#log .section").prepend(b);if("error"==a.type){var c=$('#footer [data-view="log"] mark');c.transition({opacity:1,scale:1.5},200,function(){c.transition({scale:1},200).parent().addClass("marked")})}mobserv.device.data.cordova||console.log("log",a)}},unlog:function(){navigator.vibrate&&navigator.vibrate(100);$("#log .section").html("");var a=$('#footer [data-view="log"] mark');a.parent().hasClass("marked")&&a.transition({opacity:1,scale:1.5},200,function(){a.transition({scale:.1,opacity:0},
400).parent().removeClass("marked")})},now:function(a){a=a?a:"datetime";var b=new Date;if("datetime"==a)return[b.getFullYear(),("0"+(b.getMonth()+1)).substr(-2),("0"+b.getDate()).substr(-2)].join("-")+" "+[("0"+b.getHours()).substr(-2),("0"+b.getMinutes()).substr(-2),("0"+b.getSeconds()).substr(-2)].join(":");if("date"==a)return[b.getFullYear(),("0"+(b.getMonth()+1)).substr(-2),("0"+b.getDate()).substr(-2)].join("-");if("time"==a)return[("0"+b.getHours()).substr(-2),("0"+b.getMinutes()).substr(-2),
("0"+b.getSeconds()).substr(-2)].join(":");if("timestamp"==a)return b.getTime()},exit:function(){navigator&&navigator.app?(mobserv.log({type:"notice",name:"mobserv.exit",message:"app will be closed"}),navigator.app.exitApp()):navigator&&navigator.device?(mobserv.log({type:"notice",name:"mobserv.exit",message:"device will be closed"}),navigator.device.exitApp()):mobserv.log({type:"error",name:"mobserv.exit",message:"app wont be closed"})}};